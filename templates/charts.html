<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>BUS WTF - Wait Time Forecast - Seattle</title>
  <!-- Bootstrap core CSS-->
  <link href="static/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom fonts for this template-->
  <link href="static/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <!-- Custom styles for this template-->
  <link href="static/css/sb-admin.css" rel="stylesheet">
  <!-- leaflet link-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
   integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
   crossorigin=""/>

   <!-- Make sure you put this AFTER Leaflet's CSS -->
   <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
  integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
  crossorigin=""></script>

  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>
  <script>

  function route_change(){

      document.forms['user_input_form'].action = '/route';
      document.forms['user_input_form'].submit();
  }

  function direction_change(){

      document.forms['user_input_form'].action = '/direction';
      document.forms['user_input_form'].submit();
  }
  function stop_change(){

      document.forms['user_input_form'].action = '/stop';
      document.forms['user_input_form'].submit();

  }
  </script>





  <style>
    .bar {fill:orange;stroke:orange;fill-opacity:0.5;}
    .axis { font: 16px sans-serif; }
    .chart_title { font: 20px sans-serif; }
    .hidden {
	  display: none;
	}
    #mapid { height: 350px; width: 100%; float: left;}

    img { display:block;
        margin: auto;}


    .column {
    float: left;
    width: 50%;
    padding: 10px;
}


    .row:after {
    content: "";
    display: table;
    clear: both;
}
    .description {
        padding-right:35px;
        padding-left: 35px;
        text-align: center;

    }

    .btn {

        border: 1px solid #00000054;
        padding: .15rem .5rem;
    }
    body { padding-top: 70px; }

  </style>
</head>

<body class="fixed-nav sticky-footer bg-dark" id="page-top">
  <!-- Navigation-->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" id="mainNav">
    <a class="navbar-brand" href="/">BUS WTF - Wait Time Forecast</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
              <!--
            <li class="nav-item mx-0 mx-lg-1">
              <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="#portfolio">About</a>
            </li>
        -->
            <li class="nav-item mx-0 mx-lg-1">
              <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="https://github.com/sidetrackedmind/seattle-bustime">GitHub</a>
            </li>
            <!--
            <li class="nav-item mx-0 mx-lg-1">
              <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="#contact">Methodology</a>
            </li>
        -->
          </ul>
        </div>
  </nav>
  <div class="content-wrapper">
    <div class="container-fluid">
      <!-- User Input Area-->
      <section id="header">
      <div class="card mb-3">
        <div class="card-header">

            <h3 align="center">Select a Route, Direction, Stop, Date and Hour of the Day then hit Submit!</h3>

           </div>

        <div class="user_inputs" align="center">

            <tr>
                <form name="user_input_form" >
                <td>Route</td>
                <td>
                  <select name="routeSelect" id="routeSelect" class="selectRoute" onchange="route_change();route_zoom()">
                      {% for route in route_names %}
                  		{% if route == current_route_name %}
                  			<option value="{{ current_route_name }}" selected="selected">{{ current_route_name }}</option>
                  		{% else %}
                  			<option value="{{ route }}">{{ route }}</option>
                  		{% endif %}
                  	{% endfor %}
                  </select>
                </td>
                <td>Direction</td>
                <td>
                  <select name="directionSelect" id="directionSelect" class="selectDirection" onchange="direction_change();route_zoom()">
                      {% for direction in directions %}
                  		{% if direction == current_direction %}
                  			<option name="direction" value="{{ current_direction }}" selected="selected">{{ current_direction }}</option>
                  		{% else %}
                  			<option name="direction" value="{{ direction }}">{{ direction }}</option>
                  		{% endif %}
                  	{% endfor %}
                  </select>
                </td>
            </tr>
            <tr>
                <td>Stop</td>
                <select name="stopSelect" id="stopSelect" class="selectStop" onchange="stop_change();stop_zoom()">
                    {% for stop in stop_names %}
                      {% if stop == current_stop_name %}
                          <option name="stop" value="{{ stop }}" selected="selected">{{ stop }}</option>
                      {% else %}
                          <option name="stop" value="{{ stop }}">{{ stop }}</option>
                      {% endif %}
                    {% endfor %}
                </select>
            </tr>
            <tr>
                <td>Date</td>
                <input id="dateSelect" name="dateSelect" type="date" value="{{ current_date }}"/>
                <td>Hour</td>
                <select name="hourSelect" id="hourSelect" class="selectStop" onchange="hour_change()">
                    {% for hour in hours %}
                      {% if hour == current_hour %}
                          <option selected value="{{ hour }}" id="selected_hour">{{ hour }}</option>
                      {% else %}
                          <option value="{{ hour }}">{{ hour }}</option>
                      {% endif %}
                    {% endfor %}
                </select>
                </form>
                <div class="btn-group" role="group" aria-label="...">
                <button onclick="predict()" class="btn btn-default">Submit</button>
                </div>
            </tr>
        </div>
        </section>
            <div class="row">

            <div class="col-md-6" id="chart">  </div>
          </div>
            <tr>
                <h3 id="prediction"></h3><h3 id="confidence_int"></h3>
            </tr>
        <div class="row">
        <div class="col-md-6" >
            <h2 align="center">Histogram of Bus Arrival Times</h2>
            <p class="description">This histogram shows the range of arrival times for a generic bus stop.
                            The dark area contains 90% of all arrival times. </p>
            <img width=100% src="https://s3-us-west-2.amazonaws.com/bus-wait-time-forecast/static/percentiles-01.png">
                        </div>
        <div class="col-md-6" >
            <h2 align="center">Arrival Time Prediction</h2>
            <p class="description" >When you hit submit, the model will predict a bus arrival time. The time will appear as a red bar.
                The time indicates a "predicted deviation from schedule". If the time is positive, the bus is expected to be late.
                If the time is negative, the bus is predicted to be early. In addition to the prediction, a horizontal bar will appear. The width of the bar illustrates
                 the range of arrival times for your selected stop at the selected hour.
                </p>
            <img width=100% src="https://s3-us-west-2.amazonaws.com/bus-wait-time-forecast/static/percentiles-02.png">
                        </div>
        </div>

      <!-- Prediction Space-->
      <hr>
      <!-- Map Area-->
      <div class="col-md-4" >
      <div id="mapid"></div>
      </div>
  </div>
</div>
</div>
    <footer class="sticky-footer">
      <div class="container">
        <div class="text-center">
          <small>Copyright © Benjamin Malnor 2018</small>
        </div>
      </div>
    </footer>
    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
      <i class="fa fa-angle-up"></i>
    </a>
    <!-- Logout Modal-->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
            <button class="close" type="button" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">×</span>
            </button>
          </div>
          <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
            <a class="btn btn-primary" href="login.html">Logout</a>
          </div>
        </div>
      </div>
    </div>
    <script>



    predict = function(){
	  user_route = $("#routeSelect").val()
      user_direction = $("#directionSelect").val()
	  user_stop = $("#stopSelect").val()
      user_hour = $("#hourSelect").val()
      user_date = $("#dateSelect").val()

	  user_info = {user_route : user_route, user_direction :
          user_direction, user_stop : user_stop,
          user_hour : user_hour, user_date : user_date}

	  $.post({
	    url: "/predict",
		contentType: "application/json",
		data: JSON.stringify(user_info),
		success: function(result){
    	prediction = Math.round(result.prediction)
        conf_interval_10 = Math.round(result.conf_interval_10)
        conf_interval_90 = Math.round(result.conf_interval_90)

        $("#chart").html("")

        predict_graph(prediction, conf_interval_10, conf_interval_90)

		}
	  });
	}



    predict_graph = function(prediction, conf_interval_10, conf_interval_90){

    var prediction = prediction
    var conf_interval_10 = conf_interval_10
    var conf_interval_90 = conf_interval_90
    var data = [{
			"name": "Vivek",
			"value": 40
		}];

        var margin = {
            top: 15,
            right: 100,
            bottom: 50,
            left: 100
        };
        var width = $(window).width() - margin.left - margin.right,
            height = 200 - margin.top - margin.bottom;

        var svg = d3.select("#chart").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append('g');


        var xScale = d3.scaleLinear()
            .range([margin.left, width+margin.left])
            .domain([-20, 20]);

        xAxis = d3.axisBottom()
                .scale(xScale);


      svg.append('g')
        .attr('class','axis')
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis)

        svg.append("text")
            .attr("class", "chart_title")
            .attr("transform", "translate(" + (margin.left + (width/2)) + " ," +
                                        (height + margin.top + (height/4) )+ ")")
            .style("text-anchor", "middle")
            .text("Deviation From Schedule (Minutes)");

        var bars = svg.selectAll(".bar")
            .data(data)
            .enter()


        var yaxisPoint = xScale(conf_interval_10)
        var bar_width = xScale(conf_interval_90) - yaxisPoint
        var right_text = yaxisPoint + bar_width

        var t = d3.transition()
                    .duration(750)
                    .ease(d3.easeLinear);


        //append rects
        bars.append("rect")
            .attr("class", "bar")
            .attr("y", (2*height)/3)
            .attr("height", height/4)
            .attr("x", yaxisPoint)
            .attr("width", bar_width)

        bars.append("text")
            .attr("class", "label-right")
            .attr("y", (2*height)/3+(height/8))
            .attr("x", right_text+7)
            .style("text-anchor", "left")
            .text(conf_interval_90)

        bars.append("text")
            .attr("class", "label-left")
            .attr("y", (2*height)/3+(height/8))
            .attr("x", yaxisPoint-20)
            .style("text-anchor", "right")
            .text(conf_interval_10)

        svg.append("line")
                .attr("x1", xScale(prediction))
                .attr("y1", (3*height)/6)
                .attr("x2", xScale(prediction))
                .attr("y2", ((2*height)/3)+height/4)
                .attr("stroke-width", 10)
                .attr("stroke", "#980000")

        var pred_text = svg.append("text")
                        .attr("y", (4*height)/9)
                        .attr("x", xScale(prediction))
                        .style("text-anchor", "middle")
                        .text(prediction)

                    }
    </script>
    <!--
    <script src="static/js/all_route_lines.js"></script>
    <script src="static/js/KCM_stop_shapes.js"></script>
    <script src="static/js/map_script.js"></script>
    <script>
    var selected_stop_shape = {{selected_stop_id}}
    var selected_shape = {{selected_route_shape}}
    function route_names (feature, layer) {
        layer.bindPopup(feature.properties.group);
    }

    function routeFilter (feature) {
        if (feature.properties.group == selected_shape ) return true
    }

    var selected_routes = L.geoJson(all_route_lines,
        {filter: routeFilter}).addTo(mymap);

    mymap.fitBounds(selected_routes.getBounds(), {
            //padding: [50,50]
    });


    function stopFilter (feature) {
        if (feature.properties.stop_id == selected_stop_shape ) return true
    }

    var selected_stop = L.geoJson(KCM_stop_shapes,
        {filter: stopFilter}).addTo(mymap);

    mymap.fitBounds(selected_stop.getBounds(), {
            padding: [10,10]
    });
    </script>
    <script>




    //L.geoJSON(all_route_lines, {
    //    onEachFeature: route_names
    //}).addTo(mymap);
    </script>
    -->
    <script>



    </script>

    <!-- Bootstrap core JavaScript-->
    <script src="static/vendor/jquery/jquery.min.js"></script>
    <script src="static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- Core plugin JavaScript-->
    <script src="static/vendor/jquery-easing/jquery.easing.min.js"></script>
    <!-- Page level plugin JavaScript-->
    <!-- Custom scripts for all pages-->
  </div>
</body>

</html>
